{"version":3,"sources":["../../src/actions/upload.js"],"names":["cancelUpload","uuid","client","observable","request","url","clientConfig","dataset","withCredentials","method","uploadUrl","options","testUrl","pipe","validUrl","type","json","status","Error","enableSignedUrls","muxBody","input","playback_policy","mp4_support","config","query","JSON","stringify","filename","split","slice","headers","result","asset","results","document","id","uploadFile","file","testFile","fileOptions","body","upload","event","updateAssetDocumentFromUpload","doc","err","getUpload","assetId","pollUpload","maxTries","pollInterval","tries","Promise","resolve","reject","setInterval","data","asset_id","clearInterval","_id","_type","playbackId","playback_ids","uploadId","createOrReplace","then","window","File","optionsFromFile","error","parsed","URL","protocol","match","opts","fileOpts","preserveFilename","undefined","name","contentType"],"mappings":"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","sourcesContent":["/* eslint-disable camelcase */\r\nimport {uuid as generateUuid} from '@sanity/uuid'\r\nimport config from '../config'\r\nimport {isString} from 'lodash'\r\nimport {concat, defer, from, of, throwError} from 'rxjs'\r\nimport {catchError, mergeMap, mergeMapTo, switchMap} from 'rxjs/operators'\r\nimport {getAsset} from '../actions/assets'\r\nimport {testSecretsObservable} from '../actions/secrets'\r\nimport client from '../clients/SanityClient'\r\nimport {createUpChunkObservable} from '../clients/upChunkObservable'\r\n\r\nexport function cancelUpload(uuid) {\r\n  return client.observable.request({\r\n    url: `/addons/mux/uploads/${client.clientConfig.dataset}/${uuid}`,\r\n    withCredentials: true,\r\n    method: 'DELETE',\r\n  })\r\n}\r\n\r\nexport function uploadUrl(url, options = {}) {\r\n  return testUrl(url).pipe(\r\n    switchMap((validUrl) => {\r\n      return concat(\r\n        of({type: 'url', url: validUrl}),\r\n        testSecretsObservable().pipe(\r\n          switchMap((json) => {\r\n            if (!json || !json.status) {\r\n              return throwError(new Error('Invalid credentials'))\r\n            }\r\n            const uuid = generateUuid()\r\n            const {enableSignedUrls} = options\r\n            const muxBody = {\r\n              input: validUrl,\r\n              playback_policy: [enableSignedUrls ? 'signed' : 'public'],\r\n              mp4_support: config.mp4_support,\r\n            }\r\n            const query = {\r\n              muxBody: JSON.stringify(muxBody),\r\n              filename: validUrl.split('/').slice(-1)[0],\r\n            }\r\n\r\n            const dataset = client.clientConfig.dataset\r\n            return defer(() =>\r\n              client.observable.request({\r\n                url: `/addons/mux/assets/${dataset}`,\r\n                withCredentials: true,\r\n                method: 'POST',\r\n                headers: {\r\n                  'MUX-Proxy-UUID': uuid,\r\n                  'Content-Type': 'application/json',\r\n                },\r\n                query,\r\n              })\r\n            ).pipe(\r\n              mergeMap((result) => {\r\n                const asset =\r\n                  (result && result.results && result.results[0] && result.results[0].document) ||\r\n                  null\r\n\r\n                if (!asset) {\r\n                  return throwError(new Error('No asset document returned'))\r\n                }\r\n                return of({type: 'success', id: uuid, asset})\r\n              })\r\n            )\r\n          })\r\n        )\r\n      )\r\n    })\r\n  )\r\n}\r\n\r\nexport function uploadFile(file, options = {}) {\r\n  return testFile(file).pipe(\r\n    switchMap((fileOptions) => {\r\n      return concat(\r\n        of({type: 'file', file: fileOptions}),\r\n        testSecretsObservable().pipe(\r\n          switchMap((json) => {\r\n            if (!json || !json.status) {\r\n              return throwError(new Error('Invalid credentials'))\r\n            }\r\n            const uuid = generateUuid()\r\n            const {enableSignedUrls} = options\r\n            const body = {\r\n              mp4_support: config.mp4_support,\r\n              playback_policy: [enableSignedUrls ? 'signed' : 'public'],\r\n            }\r\n\r\n            return concat(\r\n              of({type: 'uuid', uuid}),\r\n              defer(() =>\r\n                client.observable.request({\r\n                  url: `/addons/mux/uploads/${client.clientConfig.dataset}`,\r\n                  withCredentials: true,\r\n                  method: 'POST',\r\n                  headers: {\r\n                    'MUX-Proxy-UUID': uuid,\r\n                    'Content-Type': 'application/json',\r\n                  },\r\n                  body,\r\n                })\r\n              ).pipe(\r\n                mergeMap((result) => {\r\n                  return createUpChunkObservable(uuid, result.upload.url, file).pipe(\r\n                    // eslint-disable-next-line max-nested-callbacks\r\n                    mergeMap((event) => {\r\n                      if (event.type !== 'success') {\r\n                        return of(event)\r\n                      }\r\n                      return from(updateAssetDocumentFromUpload(uuid)).pipe(\r\n                        // eslint-disable-next-line max-nested-callbacks\r\n                        mergeMap((doc) => of({...event, asset: doc}))\r\n                      )\r\n                    }),\r\n                    // eslint-disable-next-line max-nested-callbacks\r\n                    catchError((err) => {\r\n                      // Delete asset document\r\n                      return cancelUpload(uuid).pipe(mergeMapTo(throwError(err)))\r\n                    })\r\n                  )\r\n                })\r\n              )\r\n            )\r\n          })\r\n        )\r\n      )\r\n    })\r\n  )\r\n}\r\n\r\nexport function getUpload(assetId) {\r\n  return client.request({\r\n    url: `/addons/mux/uploads/${client.clientConfig.dataset}/${assetId}`,\r\n    withCredentials: true,\r\n    method: 'GET',\r\n  })\r\n}\r\n\r\nexport default {uploadUrl, uploadFile, getUpload}\r\n\r\nfunction pollUpload(uuid) {\r\n  const maxTries = 10\r\n  let pollInterval\r\n  let tries = 0\r\n  let assetId\r\n  let upload\r\n  return new Promise((resolve, reject) => {\r\n    pollInterval = setInterval(async () => {\r\n      try {\r\n        upload = await getUpload(uuid)\r\n      } catch (err) {\r\n        reject(err)\r\n        return\r\n      }\r\n      assetId = upload && upload.data && upload.data.asset_id\r\n      if (assetId) {\r\n        clearInterval(pollInterval)\r\n        resolve(upload)\r\n      }\r\n      if (tries > maxTries) {\r\n        clearInterval(pollInterval)\r\n        reject(new Error('Upload did not finish'))\r\n      }\r\n      tries++\r\n    }, 2000)\r\n  })\r\n}\r\n\r\nasync function updateAssetDocumentFromUpload(uuid) {\r\n  let upload\r\n  let asset\r\n  try {\r\n    upload = await pollUpload(uuid)\r\n  } catch (err) {\r\n    return Promise.reject(err)\r\n  }\r\n  try {\r\n    asset = await getAsset(upload.data.asset_id)\r\n  } catch (err) {\r\n    return Promise.reject(err)\r\n  }\r\n\r\n  const doc = {\r\n    _id: uuid,\r\n    _type: 'mux.videoAsset',\r\n    status: asset.data.status,\r\n    data: asset.data,\r\n    assetId: asset.data.id,\r\n    playbackId: asset.data.playback_ids[0].id,\r\n    uploadId: upload.data.id,\r\n  }\r\n  return client.createOrReplace(doc).then(() => {\r\n    return doc\r\n  })\r\n}\r\n\r\nfunction testFile(file) {\r\n  if (typeof window !== 'undefined' && file instanceof window.File) {\r\n    const fileOptions = optionsFromFile(file)\r\n    return of(fileOptions)\r\n  }\r\n  return throwError(new Error('Invalid file'))\r\n}\r\n\r\nfunction testUrl(url) {\r\n  const error = new Error('Invalid URL')\r\n  if (!isString(url)) {\r\n    return throwError(error)\r\n  }\r\n  let parsed\r\n  try {\r\n    parsed = new URL(url)\r\n  } catch (err) {\r\n    return throwError(error)\r\n  }\r\n  if (parsed && !parsed.protocol.match(/http:|https:/)) {\r\n    return throwError(error)\r\n  }\r\n  return of(url)\r\n}\r\n\r\nfunction optionsFromFile(opts, file) {\r\n  if (typeof window === 'undefined' || !(file instanceof window.File)) {\r\n    return opts\r\n  }\r\n  const fileOpts = {\r\n    filename: opts.preserveFilename === false ? undefined : file.name,\r\n    contentType: file.type,\r\n  }\r\n\r\n  return {\r\n    ...{\r\n      filename: opts.preserveFilename === false ? undefined : file.name,\r\n      contentType: file.type,\r\n    },\r\n    fileOpts,\r\n  }\r\n}\r\n"],"file":"upload.js"}